// ===================================
// Global Variables
// ===================================
let projectTable = null;
let currentFilters = {
    searchField: '',
    searchText: '',
    manager_id: '',
    field_code: '',
    current_stage: '',
    page: 1,
    page_size: 100
};

// ===================================
// Initialization
// ===================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('ğŸš€ Application initializing...');
    
    try {
        // Initialize components
        await initializeFilters();
        initializeTable();
        initializeEventListeners();
        
        // Load initial data
        await loadTableData();
        
        console.log('âœ… Application initialized successfully');
    } catch (error) {
        console.error('âŒ Initialization error:', error);
        Utils.notify('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
});

// ===================================
// Initialize Filter Dropdowns
// ===================================
async function initializeFilters() {
    console.log('ğŸ“‹ Initializing filters...');
    
    try {
        // Load managers
        const managersData = await API.get(API_CONFIG.ENDPOINTS.MANAGERS);
        populateSelect('filterManager', managersData.items, 'login_id', 'user_name');
        
        // Load field codes
        const fieldsData = await API.get(`${API_CONFIG.ENDPOINTS.COMBO_DATA}/FIELD`);
        populateSelect('filterField', fieldsData.items, 'code', 'code_name');
        
        // Load stage codes
        const stagesData = await API.get(`${API_CONFIG.ENDPOINTS.COMBO_DATA}/STAGE`);
        populateSelect('filterStage', stagesData.items, 'code', 'code_name');
        
        console.log('âœ… Filters initialized');
    } catch (error) {
        console.error('âŒ Filter initialization error:', error);
    }
}

/**
 * Populate select element with options
 */
function populateSelect(elementId, items, valueKey, textKey) {
    const select = document.getElementById(elementId);
    if (!select) return;
    
    // Keep first option (ì „ì²´)
    const firstOption = select.firstElementChild;
    select.innerHTML = '';
    if (firstOption) {
        select.appendChild(firstOption);
    }
    
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueKey];
        option.textContent = item[textKey];
        select.appendChild(option);
    });
}

// ===================================
// Initialize Tabulator Table
// ===================================
function initializeTable() {
    console.log('ğŸ“Š Initializing Tabulator table...');
    
    projectTable = new Tabulator("#projectTable", {
        layout: "fitDataStretch",
        height: "600px",
        placeholder: "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
        
        // Pagination
        pagination: true,
        paginationMode: "remote",
        paginationSize: 100,
        paginationSizeSelector: [25, 50, 100, 200],
        
        // Sorting
        sortMode: "remote",
        
        // Row selection
        selectable: 1,
        selectableRangeMode: "click",
        
        // Progressive loading
        progressiveLoad: "scroll",
        
        // Column definitions
        columns: [
            {
                title: "íŒŒì´í”„ë¼ì¸",
                field: "pipeline_id",
                width: 120,
                frozen: true,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<span class="cell-pipeline-id">${value}</span>`;
                },
                cellClick: function(e, cell) {
                    const pipelineId = cell.getValue();
                    openProjectDetail(pipelineId);
                }
            },
            {
                title: "ë¶„ì•¼",
                field: "field_name",
                width: 100,
                hozAlign: "center"
            },
            {
                title: "í”„ë¡œì íŠ¸ëª…",
                field: "project_name",
                minWidth: 300,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<span title="${value}">${value}</span>`;
                }
            },
            {
                title: "ê³ ê°ì‚¬",
                field: "customer_name",
                width: 150
            },
            {
                title: "ë°œì£¼ì²˜",
                field: "ordering_party_name",
                width: 150
            },
            {
                title: "ë‹´ë‹¹ì",
                field: "manager_name",
                width: 100,
                hozAlign: "center"
            },
            {
                title: "ë‹¨ê³„",
                field: "current_stage",
                width: 120,
                hozAlign: "center",
                formatter: function(cell) {
                    const stageCode = cell.getValue();
                    return getStageBadge(stageCode);
                }
            },
            {
                title: "ê²¬ì ê¸ˆì•¡",
                field: "quoted_amount",
                width: 150,
                hozAlign: "right",
                formatter: function(cell) {
                    const value = cell.getValue();
                    const formatted = Utils.formatNumber(value);
                    const cssClass = value > 0 ? 'cell-amount positive' : 'cell-amount';
                    return `<span class="${cssClass}">${formatted}</span>`;
                }
            }
        ],
        
        // Ajax configuration for remote data
        ajaxURL: `${API_CONFIG.BASE_URL}${API_CONFIG.API_VERSION}${API_CONFIG.ENDPOINTS.PROJECTS_LIST}`,
        ajaxConfig: {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        },
        ajaxURLGenerator: function(url, config, params) {
            // Build query parameters
            const queryParams = {
                page: params.page || 1,
                page_size: params.size || 100
            };
            
            // Add filters
            if (currentFilters.searchText && currentFilters.searchField) {
                queryParams.search_field = currentFilters.searchField;
                queryParams.search_text = currentFilters.searchText;
            }
            if (currentFilters.manager_id) {
                queryParams.manager_id = currentFilters.manager_id;
            }
            if (currentFilters.field_code) {
                queryParams.field_code = currentFilters.field_code;
            }
            if (currentFilters.current_stage) {
                queryParams.current_stage = currentFilters.current_stage;
            }
            
            const queryString = new URLSearchParams(queryParams).toString();
            return `${url}?${queryString}`;
        },
        ajaxResponse: function(url, params, response) {
            console.log('ğŸ“¥ Data received:', response);
            
            // Update statistics
            updateStatistics(response);
            
            // Return data for Tabulator
            return {
                last_page: response.total_pages,
                data: response.items
            };
        },
        ajaxError: function(error) {
            console.error('âŒ Ajax error:', error);
            Utils.notify('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    });
    
    console.log('âœ… Table initialized');
}

// ===================================
// Load Table Data
// ===================================
async function loadTableData() {
    console.log('ğŸ”„ Loading table data...');
    Utils.showLoading(true);
    
    try {
        // Trigger table reload
        await projectTable.setData();
        console.log('âœ… Data loaded successfully');
    } catch (error) {
        console.error('âŒ Error loading data:', error);
        Utils.notify('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        Utils.showLoading(false);
    }
}

// ===================================
// Update Statistics
// ===================================
function updateStatistics(response) {
    const stats = response.statistics || {};
    
    // Total projects
    document.getElementById('statTotal').textContent = 
        Utils.formatNumber(response.total_items || 0);
    
    // Progress count (stages S01-S03)
    const progressCount = stats.stage_counts?.['S01'] || 0 + 
                         stats.stage_counts?.['S02'] || 0 + 
                         stats.stage_counts?.['S03'] || 0;
    document.getElementById('statProgress').textContent = 
        Utils.formatNumber(progressCount);
    
    // Completed count (stages S04-S05)
    const completedCount = stats.stage_counts?.['S04'] || 0 + 
                          stats.stage_counts?.['S05'] || 0;
    document.getElementById('statCompleted').textContent = 
        Utils.formatNumber(completedCount);
    
    // Total amount
    document.getElementById('statAmount').textContent = 
        Utils.formatCurrency(stats.total_amount || 0);
}

// ===================================
// Initialize Event Listeners
// ===================================
function initializeEventListeners() {
    console.log('ğŸ¯ Initializing event listeners...');
    
    // Refresh button
    document.getElementById('btnRefresh').addEventListener('click', () => {
        console.log('ğŸ”„ Refresh clicked');
        loadTableData();
    });
    
    // Export button
    document.getElementById('btnExport').addEventListener('click', () => {
        console.log('ğŸ“Š Export clicked');
        exportToExcel();
    });
    
    // Add button
    document.getElementById('btnAdd').addEventListener('click', () => {
        console.log('â• Add clicked');
        openProjectForm();
    });
    
    // Search field change
    document.getElementById('searchField').addEventListener('change', (e) => {
        currentFilters.searchField = e.target.value;
    });
    
    // Search text with debounce
    document.getElementById('searchText').addEventListener('input', 
        Utils.debounce((e) => {
            currentFilters.searchText = e.target.value;
            if (e.target.value.length >= 2 || e.target.value.length === 0) {
                loadTableData();
            }
        }, 500)
    );
    
    // Enter key in search box
    document.getElementById('searchText').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            currentFilters.searchText = e.target.value;
            loadTableData();
        }
    });
    
    // Manager filter
    document.getElementById('filterManager').addEventListener('change', (e) => {
        currentFilters.manager_id = e.target.value;
        loadTableData();
    });
    
    // Field filter
    document.getElementById('filterField').addEventListener('change', (e) => {
        currentFilters.field_code = e.target.value;
        loadTableData();
    });
    
    // Stage filter
    document.getElementById('filterStage').addEventListener('change', (e) => {
        currentFilters.current_stage = e.target.value;
        loadTableData();
    });
    
    // Page size
    document.getElementById('pageSize').addEventListener('change', (e) => {
        currentFilters.page_size = parseInt(e.target.value);
        projectTable.setPageSize(currentFilters.page_size);
    });
    
    // Modal close on background click
    document.getElementById('projectModal').addEventListener('click', (e) => {
        if (e.target.id === 'projectModal') {
            closeModal();
        }
    });
    
    console.log('âœ… Event listeners initialized');
}

// ===================================
// Export to Excel
// ===================================
function exportToExcel() {
    console.log('ğŸ“¥ Exporting to Excel...');
    
    try {
        // Get all data from table
        const data = projectTable.getData();
        
        if (data.length === 0) {
            Utils.notify('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        
        // Prepare data for export
        const exportData = data.map(row => ({
            'íŒŒì´í”„ë¼ì¸ID': row.pipeline_id,
            'ë¶„ì•¼': row.field_name,
            'í”„ë¡œì íŠ¸ëª…': row.project_name,
            'ê³ ê°ì‚¬': row.customer_name,
            'ë°œì£¼ì²˜': row.ordering_party_name,
            'ë‹´ë‹¹ì': row.manager_name,
            'ë‹¨ê³„': row.current_stage,
            'ê²¬ì ê¸ˆì•¡': row.quoted_amount
        }));
        
        // Create workbook
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "í”„ë¡œì íŠ¸ëª©ë¡");
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 10);
        const filename = `í”„ë¡œì íŠ¸ëª©ë¡_${timestamp}.xlsx`;
        
        // Download
        XLSX.writeFile(wb, filename);
        
        console.log('âœ… Excel export completed');
        Utils.notify('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (error) {
        console.error('âŒ Export error:', error);
        Utils.notify('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ===================================
// Open Project Detail Modal
// ===================================
async function openProjectDetail(pipelineId) {
    console.log('ğŸ” Opening project detail:', pipelineId);
    Utils.showLoading(true);
    
    try {
        // Fetch project detail
        const data = await API.get(`${API_CONFIG.ENDPOINTS.PROJECT_DETAIL}/${pipelineId}/full`);
        
        // Render modal content
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = renderProjectDetail(data);
        
        // Show modal
        document.getElementById('projectModal').classList.add('active');
        
    } catch (error) {
        console.error('âŒ Error loading project detail:', error);
        Utils.notify('í”„ë¡œì íŠ¸ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        Utils.showLoading(false);
    }
}

// ===================================
// Render Project Detail
// ===================================
function renderProjectDetail(data) {
    const project = data.project;
    const attributes = data.attributes || [];
    const histories = data.histories || [];
    
    return `
        <div class="detail-section">
            <h3 class="mb-2">
                <i class="fas fa-info-circle"></i> ê¸°ë³¸ ì •ë³´
            </h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <label>íŒŒì´í”„ë¼ì¸ ID</label>
                    <div class="font-bold">${project.pipeline_id}</div>
                </div>
                <div class="detail-item">
                    <label>í”„ë¡œì íŠ¸ëª…</label>
                    <div class="font-bold">${project.project_name}</div>
                </div>
                <div class="detail-item">
                    <label>ì‚¬ì—…ë¶„ì•¼</label>
                    <div>${project.field_name || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>ë‹´ë‹¹ì</label>
                    <div>${project.manager_name || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>ê³ ê°ì‚¬</label>
                    <div>${project.customer_name || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>ë°œì£¼ì²˜</label>
                    <div>${project.ordering_party_name || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>ì§„í–‰ë‹¨ê³„</label>
                    <div>${getStageBadge(project.current_stage)}</div>
                </div>
                <div class="detail-item">
                    <label>ê²¬ì ê¸ˆì•¡</label>
                    <div class="font-bold text-success">${Utils.formatCurrency(project.quoted_amount)}</div>
                </div>
            </div>
        </div>
        
        ${attributes.length > 0 ? `
        <div class="detail-section mt-3">
            <h3 class="mb-2">
                <i class="fas fa-tags"></i> ì†ì„± ì •ë³´
            </h3>
            <div class="detail-grid">
                ${attributes.map(attr => `
                    <div class="detail-item">
                        <label>${attr.attr_name}</label>
                        <div>${attr.attr_value || '-'}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${histories.length > 0 ? `
        <div class="detail-section mt-3">
            <h3 class="mb-2">
                <i class="fas fa-history"></i> ì´ë ¥ ì •ë³´
            </h3>
            <div class="history-list">
                ${histories.map(hist => `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-date">
                                <i class="fas fa-calendar"></i>
                                ${Utils.formatDate(hist.base_date)}
                            </span>
                            <span>${getStageBadge(hist.progress_stage)}</span>
                        </div>
                        <div class="history-content">
                            ${hist.strategy_content || '-'}
                        </div>
                        <div class="history-footer">
                            <span class="text-muted">
                                <i class="fas fa-user"></i> ${hist.creator_name}
                            </span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <style>
            .detail-section {
                margin-bottom: 2rem;
            }
            .detail-section h3 {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .detail-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
            .detail-item label {
                display: block;
                font-size: 0.875rem;
                color: var(--text-secondary);
                margin-bottom: 0.25rem;
            }
            .detail-item > div {
                font-size: 1rem;
            }
            .history-list {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .history-item {
                background: #f8f9fa;
                border-left: 3px solid var(--primary-color);
                padding: 1rem;
                border-radius: var(--radius-md);
            }
            .history-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            .history-date {
                font-weight: 600;
                color: var(--text-secondary);
            }
            .history-content {
                margin: 0.75rem 0;
                line-height: 1.6;
            }
            .history-footer {
                font-size: 0.875rem;
                margin-top: 0.5rem;
            }
        </style>
    `;
}

// ===================================
// Close Modal
// ===================================
function closeModal() {
    document.getElementById('projectModal').classList.remove('active');
}

// ===================================
// Open Project Form (Placeholder)
// ===================================
function openProjectForm() {
    Utils.notify('í”„ë¡œì íŠ¸ ì¶”ê°€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    // TODO: Implement project form
}

// ===================================
// Export functions for global access
// ===================================
window.closeModal = closeModal;
window.openProjectDetail = openProjectDetail;
