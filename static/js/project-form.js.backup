/**
 * static/js/project-form.js
 * ì˜ì—… > ì‹ ê·œí”„ë¡œì íŠ¸ í™”ë©´ ìˆ˜ì •
 * 
 * ìˆ˜ì • ë‚´ìš©:
 * 1.1 ì§„í–‰ë‹¨ê³„, ë‹´ë‹¹ì ì½¤ë³´ë°•ìŠ¤ ë°ì´í„° ë¡œë“œ ìˆ˜ì •
 * 1.2 ê³ ê°ì‚¬/ë°œì£¼ì²˜ ì„ íƒ ëª¨ë‹¬ (ê²€ìƒ‰ + í˜ì´ì§•)
 * 1.3 ìˆ˜ì£¼í™•ë¥ (win_probability), ë¹„ê³ (notes) í•„ë“œ ì¶”ê°€
 * 2.1 ì†ì„±ì •ë³´ íƒ­ - PROJECT_ATTRIBUTE ì½¤ë³´ë°•ìŠ¤
 * 3.1 ë³€ê²½ì´ë ¥ íƒ­ - progress_stage ì½¤ë³´ë°•ìŠ¤, ê¸°ë³¸ê°’ S01
 * 
 * ë²„ê·¸ ìˆ˜ì • (2026-01-31):
 * - ê³ ê°ì‚¬/ë°œì£¼ì²˜ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜ ìˆ˜ì •
 * - ì†ì„±ì •ë³´ DB ì €ì¥ ì˜¤ë¥˜ ìˆ˜ì • (row_stat ê´€ë¦¬)
 * - ë³€ê²½ì´ë ¥ DB ì €ì¥ ì˜¤ë¥˜ ìˆ˜ì • (row_stat ê´€ë¦¬)
 */

// ===================================
// Project Form State
// ===================================
let formMode = 'new';  // 'new' or 'edit'
let currentPipelineId = null;
let attributes = [];
let histories = [];

// ì½¤ë³´ë°•ìŠ¤ ë°ì´í„° ìºì‹œ
let stageOptions = [];
let attributeOptions = [];

// ê³ ê°ì‚¬ ì„ íƒ ëª¨ë‹¬ ìƒíƒœ
let clientSearchPage = 1;
let clientSearchTarget = '';  // 'customer' or 'ordering_party'
let selectedCustomerId = null;
let selectedOrderingPartyId = null;

// ===================================
// Initialize Project Form
// ===================================
async function initializeProjectForm(mode = 'new', pipelineId = null) {
    formMode = mode;
    currentPipelineId = pipelineId;
    
    console.log('ğŸ“ í¼ ì´ˆê¸°í™”:', mode, pipelineId);
    
    // âœ… ë²„ê·¸ ìˆ˜ì •: ì œëª© í…ìŠ¤íŠ¸ë§Œ ë³€ê²½ (ì•„ì´ì½˜ì€ HTMLì— ì´ë¯¸ ìˆìŒ)
    const titleElement = document.getElementById('formTitle');
    const titleIcon = titleElement.parentElement.querySelector('i');  // ë¶€ëª¨ì˜ ì•„ì´ì½˜
    
    if (mode === 'new') {
        titleElement.textContent = 'ì‹ ê·œ í”„ë¡œì íŠ¸';  // í…ìŠ¤íŠ¸ë§Œ ë³€ê²½
        if (titleIcon) titleIcon.className = 'fas fa-plus-circle';
        document.getElementById('pipeline_id').value = 'ìë™ìƒì„±';
    } else {
        titleElement.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';  // í…ìŠ¤íŠ¸ë§Œ ë³€ê²½
        if (titleIcon) titleIcon.className = 'fas fa-edit';
    }
    
    // ì½¤ë³´ë°•ìŠ¤ ì´ˆê¸°í™” (ìˆ˜ì •ë¨)
    await loadFormComboBoxes();
    
    // íƒ­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    initializeFormTabs();
    
    // ê³ ê°ì‚¬ ì„ íƒ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    initializeClientSearch();
    
    // ìˆ˜ì • ëª¨ë“œë©´ ë°ì´í„° ë¡œë“œ
    if (mode === 'edit' && pipelineId) {
        await loadProjectData(pipelineId);
    } else {
        // ì‹ ê·œ ëª¨ë“œë©´ í¼ ì´ˆê¸°í™”
        resetForm();
        
        // 3.1 ì‹ ê·œ ë“±ë¡ì‹œ ì§„í–‰ë‹¨ê³„ ê¸°ë³¸ê°’ 'S01'
        document.getElementById('current_stage').value = 'S01';
    }
}

// ===================================
// Load ComboBoxes
// ===================================
async function loadFormComboBoxes() {
    try {
        console.log('ğŸ“¦ ì½¤ë³´ë°•ìŠ¤ ë°ì´í„° ë¡œë”© ì‹œì‘...');
        
        // 1.1 ì§„í–‰ë‹¨ê³„ ì½¤ë³´ë°•ìŠ¤ (STAGE)
        const stages = await API.get(`${API_CONFIG.ENDPOINTS.COMBO_DATA}/STAGE`);
        const stageSelect = document.getElementById('current_stage');
        stageSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        console.log('ğŸ“¥ ì§„í–‰ë‹¨ê³„ ë°ì´í„°:', stages);
        
        if (stages && stages.items) {
            stageOptions = stages.items;
            stages.items.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.code;
                opt.textContent = s.code_name;
                stageSelect.appendChild(opt);
            });
        }
        
        // 1.1 ì‚¬ì—…ë¶„ì•¼ ì½¤ë³´ë°•ìŠ¤ (FIELD)
        const fields = await API.get(`${API_CONFIG.ENDPOINTS.COMBO_DATA}/FIELD`);
        const fieldSelect = document.getElementById('field_code');
        fieldSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        console.log('ğŸ“¥ ì‚¬ì—…ë¶„ì•¼ ë°ì´í„°:', fields);
        
        if (fields && fields.items) {
            fields.items.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.code;
                opt.textContent = f.code_name;
                fieldSelect.appendChild(opt);
            });
        }
        
        // 1.1 ë‹´ë‹¹ì ì½¤ë³´ë°•ìŠ¤
        const managers = await API.get(API_CONFIG.ENDPOINTS.MANAGERS);
        const managerSelect = document.getElementById('manager_id');
        managerSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        console.log('ğŸ“¥ ë‹´ë‹¹ì ë°ì´í„°:', managers);
        
        // items ë°°ì—´ì—ì„œ ë°ì´í„° ë¡œë“œ
        const managerList = managers?.items || managers?.managers || [];
        managerList.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.manager_id || m.login_id;
            opt.textContent = m.manager_name || m.user_name;
            managerSelect.appendChild(opt);
        });
        
        // 2.1 í”„ë¡œì íŠ¸ ì†ì„± ì½¤ë³´ë°•ìŠ¤ ë°ì´í„° ë¡œë“œ
        try {
            const attrs = await API.get(`${API_CONFIG.ENDPOINTS.COMBO_DATA}/PROJECT_ATTRIBUTE`);
            console.log('ğŸ“¥ í”„ë¡œì íŠ¸ ì†ì„± ë°ì´í„°:', attrs);
            if (attrs && attrs.items) {
                attributeOptions = attrs.items;
            }
        } catch (e) {
            console.warn('âš ï¸ PROJECT_ATTRIBUTE ë¡œë“œ ì‹¤íŒ¨:', e);
            attributeOptions = [];
        }
        
        console.log('âœ… ì½¤ë³´ë°•ìŠ¤ ë¡œë”© ì™„ë£Œ');
        
    } catch (error) {
        console.error('âŒ ì½¤ë³´ë°•ìŠ¤ ë¡œë”© ì‹¤íŒ¨:', error);
    }
}

// ===================================
// Load Project Data (ìˆ˜ì • ëª¨ë“œ)
// ===================================
async function loadProjectData(pipelineId) {
    try {
        Utils.showLoading(true);
        
        const response = await API.get(`${API_CONFIG.ENDPOINTS.PROJECT_DETAIL}/${pipelineId}/full`);
        console.log('ğŸ“¥ í”„ë¡œì íŠ¸ ë°ì´í„°:', response);
        
        if (response) {
            const project = response.project || response;
            
            // ê¸°ë³¸ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('pipeline_id').value = project.pipeline_id || '';
            document.getElementById('project_name').value = project.project_name || '';
            document.getElementById('field_code').value = project.field_code || '';
            document.getElementById('current_stage').value = project.current_stage || project.progress_stage || '';
            document.getElementById('manager_id').value = project.manager_id || '';
            
            // âœ… ê³ ê°ì‚¬/ë°œì£¼ì²˜ ìˆ˜ì • (ë””ë²„ê¹… ê°•í™”)
            console.log('ğŸ¢ ê³ ê°ì‚¬/ë°œì£¼ì²˜ ì •ë³´:', {
                customer_id: project.customer_id,
                customer_name: project.customer_name,
                ordering_party_id: project.ordering_party_id,
                ordering_party_name: project.ordering_party_name
            });
            
            // ê³ ê°ì‚¬ ì„¤ì •
            if (project.customer_id) {
                selectedCustomerId = project.customer_id;
                
                const customerIdEl = document.getElementById('customer_id');
                const customerNameEl = document.getElementById('customer_name');
                
                if (customerIdEl && customerNameEl) {
                    customerIdEl.value = project.customer_id;
                    customerNameEl.value = project.customer_name || '';
                    
                    // âœ… ê°’ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ì¦‰ì‹œ í™•ì¸
                    console.log('âœ… ê³ ê°ì‚¬ ì„¤ì • ì™„ë£Œ:', {
                        id_value: customerIdEl.value,
                        name_value: customerNameEl.value
                    });
                } else {
                    console.error('âŒ ê³ ê°ì‚¬ input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', {
                        customerIdEl: !!customerIdEl,
                        customerNameEl: !!customerNameEl
                    });
                }
            } else {
                console.warn('âš ï¸ ê³ ê°ì‚¬ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // ë°œì£¼ì²˜ ì„¤ì •
            if (project.ordering_party_id) {
                selectedOrderingPartyId = project.ordering_party_id;
                
                const orderingPartyIdEl = document.getElementById('ordering_party_id');
                const orderingPartyNameEl = document.getElementById('ordering_party_name');
                
                if (orderingPartyIdEl && orderingPartyNameEl) {
                    orderingPartyIdEl.value = project.ordering_party_id;
                    orderingPartyNameEl.value = project.ordering_party_name || '';
                    
                    // âœ… ê°’ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ì¦‰ì‹œ í™•ì¸
                    console.log('âœ… ë°œì£¼ì²˜ ì„¤ì • ì™„ë£Œ:', {
                        id_value: orderingPartyIdEl.value,
                        name_value: orderingPartyNameEl.value
                    });
                } else {
                    console.error('âŒ ë°œì£¼ì²˜ input ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', {
                        orderingPartyIdEl: !!orderingPartyIdEl,
                        orderingPartyNameEl: !!orderingPartyNameEl
                    });
                }
            } else {
                console.log('â„¹ï¸ ë°œì£¼ì²˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            document.getElementById('quoted_amount').value = project.quoted_amount || '';
            
            // 1.3 ìˆ˜ì£¼í™•ë¥ , ë¹„ê³  (ì‹ ê·œ í•„ë“œ)
            const winProbEl = document.getElementById('win_probability');
            if (winProbEl) winProbEl.value = project.win_probability || '';
            
            const notesEl = document.getElementById('notes');
            if (notesEl) notesEl.value = project.notes || '';
            
            // âœ… ì†ì„± ë¡œë“œ - ê¸°ì¡´ ë°ì´í„°ëŠ” row_statì„ ë¹ˆê°’ìœ¼ë¡œ (ìˆ˜ì • ì‹œ 'U'ë¡œ ë³€ê²½)
            attributes = (response.attributes || []).map(attr => ({
                attr_code: attr.attr_code,
                attr_value: attr.attr_value || '',
                attr_name: attr.attr_name || '',
                row_stat: ''  // ê¸°ì¡´ ë°ì´í„°: ë¹ˆê°’ (ë³€ê²½ ì‹œ 'U')
            }));
            renderAttributes();
            
            // âœ… ì´ë ¥ ë¡œë“œ - ê¸°ì¡´ ë°ì´í„°ëŠ” row_statì„ ë¹ˆê°’ìœ¼ë¡œ
            histories = (response.histories || []).map(hist => ({
                history_id: hist.history_id,
                base_date: hist.base_date,
                progress_stage: hist.progress_stage,
                strategy_content: hist.strategy_content || '',
                stage_name: hist.stage_name || '',
                row_stat: ''  // ê¸°ì¡´ ë°ì´í„°: ë¹ˆê°’ (ë³€ê²½ ì‹œ 'U')
            }));
            renderHistories();
            
            console.log('âœ… í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            console.log('   - ì†ì„±:', attributes.length, 'ê°œ');
            console.log('   - ì´ë ¥:', histories.length, 'ê°œ');
        }
        
        Utils.showLoading(false);
    } catch (error) {
        console.error('âŒ í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
        Utils.showLoading(false);
        alert('í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ===================================
// Reset Form
// ===================================
function resetForm() {
    document.getElementById('pipeline_id').value = 'ìë™ìƒì„±';
    document.getElementById('project_name').value = '';
    document.getElementById('field_code').value = '';
    document.getElementById('current_stage').value = 'S01';  // 3.1 ê¸°ë³¸ê°’ S01
    document.getElementById('manager_id').value = '';
    
    // ê³ ê°ì‚¬/ë°œì£¼ì²˜ ì´ˆê¸°í™”
    const customerIdEl = document.getElementById('customer_id');
    if (customerIdEl) customerIdEl.value = '';
    document.getElementById('customer_name').value = '';
    
    const orderingPartyIdEl = document.getElementById('ordering_party_id');
    if (orderingPartyIdEl) orderingPartyIdEl.value = '';
    document.getElementById('ordering_party_name').value = '';
    
    selectedCustomerId = null;
    selectedOrderingPartyId = null;
    
    document.getElementById('quoted_amount').value = '';
    
    const winProbEl = document.getElementById('win_probability');
    if (winProbEl) winProbEl.value = '';
    
    const notesEl = document.getElementById('notes');
    if (notesEl) notesEl.value = '';
    
    attributes = [];
    histories = [];
    renderAttributes();
    renderHistories();
}

// ===================================
// Tab Navigation
// ===================================
function initializeFormTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            tabBtns.forEach(b => b.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));
            
            // ì„ íƒí•œ íƒ­ í™œì„±í™”
            btn.classList.add('active');
            const targetPane = document.getElementById('tab-' + targetTab);
            if (targetPane) {
                targetPane.classList.add('active');
            }
        });
    });
}

// ===================================
// Client Search Modal
// ===================================
function initializeClientSearch() {
    // ê³ ê°ì‚¬ ê²€ìƒ‰ ë²„íŠ¼
    const customerBtn = document.getElementById('customer_search_btn');
    const customerInput = document.getElementById('customer_name');
    
    if (customerBtn) {
        customerBtn.addEventListener('click', () => openClientSearchModal('customer'));
    }
    if (customerInput) {
        customerInput.addEventListener('click', () => openClientSearchModal('customer'));
    }
    
    // ë°œì£¼ì²˜ ê²€ìƒ‰ ë²„íŠ¼
    const orderingBtn = document.getElementById('ordering_party_search_btn');
    const orderingInput = document.getElementById('ordering_party_name');
    
    if (orderingBtn) {
        orderingBtn.addEventListener('click', () => openClientSearchModal('ordering_party'));
    }
    if (orderingInput) {
        orderingInput.addEventListener('click', () => openClientSearchModal('ordering_party'));
    }
}

async function openClientSearchModal(target) {
    clientSearchTarget = target;
    clientSearchPage = 1;
    
    const modal = document.getElementById('clientSearchModal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('clientSearchInput').value = '';
        document.getElementById('clientSearchResults').innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>';
    }
}

async function searchClients(page = 1) {
    try {
        clientSearchPage = page;
        
        const searchInput = document.getElementById('clientSearchInput');
        const searchText = searchInput ? searchInput.value.trim() : '';
        
        Utils.showLoading(true);
        
        const response = await API.get(`${API_CONFIG.ENDPOINTS.CLIENTS_SEARCH}?search_text=${encodeURIComponent(searchText)}&page=${page}&page_size=10`);
        
        Utils.showLoading(false);
        
        renderClientSearchResults(response);
        
    } catch (error) {
        console.error('âŒ ê±°ë˜ì²˜ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
        Utils.showLoading(false);
        alert('ê±°ë˜ì²˜ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderClientSearchResults(response) {
    const container = document.getElementById('clientSearchResults');
    if (!container) return;
    
    const items = response.items || [];
    
    if (items.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '<div class="client-results-list">';
    items.forEach(client => {
        html += `
            <div class="client-result-item" onclick="selectClient(${client.client_id}, '${client.client_name.replace(/'/g, "\\'")}')">
                <div class="client-result-name">${client.client_name}</div>
                <div class="client-result-info">
                    ${client.business_number ? `<span>ì‚¬ì—…ì: ${client.business_number}</span>` : ''}
                    ${client.ceo_name ? `<span>ëŒ€í‘œ: ${client.ceo_name}</span>` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
    
    // í˜ì´ì§• ë Œë”ë§
    renderClientPagination(response);
}

function renderClientPagination(response) {
    const container = document.getElementById('clientSearchPagination');
    if (!container) return;
    
    const totalPages = response.total_pages || 1;
    const currentPage = response.current_page || 1;
    
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="searchClients(${i})">${i}</button>`;
    }
    container.innerHTML = html;
}

// ê³ ê°ì‚¬ ì„ íƒ
function selectClient(clientId, clientName) {
    if (clientSearchTarget === 'customer') {
        selectedCustomerId = clientId;
        const customerIdEl = document.getElementById('customer_id');
        if (customerIdEl) customerIdEl.value = clientId;
        document.getElementById('customer_name').value = clientName;
        
        console.log('âœ… ê³ ê°ì‚¬ ì„ íƒ:', { clientId, clientName });
    } else {
        selectedOrderingPartyId = clientId;
        const orderingPartyIdEl = document.getElementById('ordering_party_id');
        if (orderingPartyIdEl) orderingPartyIdEl.value = clientId;
        document.getElementById('ordering_party_name').value = clientName;
        
        console.log('âœ… ë°œì£¼ì²˜ ì„ íƒ:', { clientId, clientName });
    }
    
    closeClientSearchModal();
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeClientSearchModal() {
    const modal = document.getElementById('clientSearchModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ===================================
// 2.1 Attributes Management (ìˆ˜ì •ë¨)
// ===================================
function addAttribute() {
    // 2.1 ì†ì„± ì¶”ê°€
    const attrCodeSelect = document.getElementById('new_attr_code');
    const attrValueInput = document.getElementById('new_attr_value');
    
    if (!attrCodeSelect) {
        console.warn('âš ï¸ ì†ì„± ì½”ë“œ select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    const attrCode = attrCodeSelect.value;
    const attrValue = attrValueInput ? attrValueInput.value.trim() : '';
    
    if (!attrCode) {
        alert('ì†ì„±ëª…ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // 2.1 ì¤‘ë³µ ì²´í¬ (ì‚­ì œ í‘œì‹œëœ ê²ƒ ì œì™¸)
    const isDuplicate = attributes.some(attr => attr.attr_code === attrCode && attr.row_stat !== 'D');
    if (isDuplicate) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ì†ì„±ì…ë‹ˆë‹¤. ë™ì¼í•œ ì†ì„±ì€ ì¤‘ë³µ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì†ì„±ëª… ì°¾ê¸°
    const selectedOption = attributeOptions.find(opt => opt.code === attrCode);
    const attrName = selectedOption ? selectedOption.code_name : attrCode;
    
    // âœ… ì‹ ê·œ ì†ì„± ì¶”ê°€ (row_stat: 'N' ì„¤ì • í•„ìˆ˜)
    attributes.push({
        attr_code: attrCode,
        attr_value: attrValue,
        attr_name: attrName,
        row_stat: 'N'  // âœ… ì‹ ê·œ í‘œì‹œ
    });
    
    console.log('âœ… ì†ì„± ì¶”ê°€:', { attrCode, attrValue, attrName, row_stat: 'N' });
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    attrCodeSelect.value = '';
    if (attrValueInput) attrValueInput.value = '';
    
    // ë Œë”ë§
    renderAttributes();
}

// âœ… ì†ì„± ìˆ˜ì • í•¨ìˆ˜
function editAttribute(index) {
    const attr = attributes[index];
    
    const newValue = prompt('ì†ì„± ê°’ì„ ì…ë ¥í•˜ì„¸ìš”:', attr.attr_value || '');
    
    if (newValue !== null && newValue !== attr.attr_value) {
        attributes[index].attr_value = newValue.trim();
        
        // âœ… ì‹ ê·œ(N)ê°€ ì•„ë‹ˆê³  ì‚­ì œ(D)ê°€ ì•„ë‹ˆë©´ ìˆ˜ì •(U)ìœ¼ë¡œ í‘œì‹œ
        if (attr.row_stat !== 'N' && attr.row_stat !== 'D') {
            attributes[index].row_stat = 'U';
            console.log('âœ… ì†ì„± ìˆ˜ì •:', { index, attr_code: attr.attr_code, row_stat: 'U' });
        }
        
        renderAttributes();
    }
}

// âœ… ì†ì„± ì‚­ì œ í•¨ìˆ˜
function deleteAttribute(index) {
    const attr = attributes[index];
    
    if (!confirm(`"${attr.attr_name || attr.attr_code}" ì†ì„±ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    // âœ… ì‹ ê·œ(N)ë¡œ ì¶”ê°€ëœ ê²ƒì€ ë°°ì—´ì—ì„œ ì œê±°, ê¸°ì¡´ ë°ì´í„°ëŠ” 'D'ë¡œ í‘œì‹œ
    if (attr.row_stat === 'N') {
        // ì‹ ê·œ ì¶”ê°€ëœ ê²ƒì€ ì™„ì „íˆ ì œê±°
        attributes.splice(index, 1);
        console.log('âœ… ì‹ ê·œ ì†ì„± ì œê±°:', { index });
    } else {
        // ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œ í‘œì‹œ
        attributes[index].row_stat = 'D';
        console.log('âœ… ê¸°ì¡´ ì†ì„± ì‚­ì œ í‘œì‹œ:', { index, attr_code: attr.attr_code, row_stat: 'D' });
    }
    
    renderAttributes();
}

// âœ… ì†ì„± ë Œë”ë§ í•¨ìˆ˜
function renderAttributes() {
    const container = document.getElementById('attributesList');
    if (!container) return;
    
    // ì‚­ì œ í‘œì‹œëœ ê²ƒ ì œì™¸í•˜ê³  í‘œì‹œ
    const visibleAttrs = attributes.filter(a => a.row_stat !== 'D');
    
    if (visibleAttrs.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>ë“±ë¡ëœ ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="attributes-list">';
    
    visibleAttrs.forEach((attr) => {
        // ì‹¤ì œ ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        const realIndex = attributes.indexOf(attr);
        
        const statusBadge = attr.row_stat === 'N' ? 
            '<span class="badge badge-new">ì‹ ê·œ</span>' : 
            (attr.row_stat === 'U' ? '<span class="badge badge-modified">ìˆ˜ì •ë¨</span>' : '');
        
        html += `
            <div class="attribute-item">
                <div class="attribute-info">
                    <strong>${attr.attr_name || attr.attr_code}</strong>
                    <span class="attribute-value">${attr.attr_value || '-'}</span>
                    ${statusBadge}
                </div>
                <div class="attribute-actions">
                    <button type="button" class="btn-icon" onclick="editAttribute(${realIndex})" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn-icon btn-danger" onclick="deleteAttribute(${realIndex})" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log('ğŸ“Š ì†ì„± ë Œë”ë§:', {
        total: attributes.length,
        visible: visibleAttrs.length,
        new: attributes.filter(a => a.row_stat === 'N').length,
        updated: attributes.filter(a => a.row_stat === 'U').length,
        deleted: attributes.filter(a => a.row_stat === 'D').length
    });
}

// ë ˆê±°ì‹œ í•¨ìˆ˜ í˜¸í™˜ì„± ìœ ì§€
function removeAttribute(index) {
    deleteAttribute(index);
}

function updateAttribute(index) {
    editAttribute(index);
}

// ===================================
// 3.1 Histories Management (ìˆ˜ì •ë¨)
// ===================================
function addHistory() {
    const baseDateInput = document.getElementById('new_history_date');
    const stageSelect = document.getElementById('new_history_stage');
    const contentInput = document.getElementById('new_history_content');
    
    if (!baseDateInput || !stageSelect) {
        console.warn('âš ï¸ ì´ë ¥ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    const baseDate = baseDateInput.value;
    const progressStage = stageSelect.value;
    const strategyContent = contentInput ? contentInput.value.trim() : '';
    
    if (!baseDate) {
        alert('ê¸°ì¤€ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    
    if (!progressStage) {
        alert('ì§„í–‰ë‹¨ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // ì§„í–‰ë‹¨ê³„ëª… ì°¾ê¸°
    const selectedOption = stageOptions.find(opt => opt.code === progressStage);
    const stageName = selectedOption ? selectedOption.code_name : progressStage;
    
    // âœ… ì‹ ê·œ ì´ë ¥ ì¶”ê°€ (row_stat: 'N' ì„¤ì • í•„ìˆ˜)
    histories.push({
        history_id: null,  // ì‹ ê·œëŠ” ID ì—†ìŒ
        base_date: baseDate,
        progress_stage: progressStage,
        strategy_content: strategyContent,
        stage_name: stageName,
        row_stat: 'N'  // âœ… ì‹ ê·œ í‘œì‹œ
    });
    
    console.log('âœ… ì´ë ¥ ì¶”ê°€:', { baseDate, progressStage, stageName, row_stat: 'N' });
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    baseDateInput.value = '';
    stageSelect.value = 'S01';  // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
    if (contentInput) contentInput.value = '';
    
    // ë Œë”ë§
    renderHistories();
}

// âœ… ì´ë ¥ ìˆ˜ì • í•¨ìˆ˜
function editHistory(index) {
    const hist = histories[index];
    
    // ìˆ˜ì • UI í‘œì‹œ (ê°„ë‹¨í•˜ê²Œ prompt ì‚¬ìš©)
    const newContent = prompt('ì „ëµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', hist.strategy_content || '');
    
    if (newContent !== null && newContent !== hist.strategy_content) {
        histories[index].strategy_content = newContent.trim();
        
        // âœ… ì‹ ê·œ(N)ê°€ ì•„ë‹ˆê³  ì‚­ì œ(D)ê°€ ì•„ë‹ˆë©´ ìˆ˜ì •(U)ìœ¼ë¡œ í‘œì‹œ
        if (hist.row_stat !== 'N' && hist.row_stat !== 'D') {
            histories[index].row_stat = 'U';
            console.log('âœ… ì´ë ¥ ìˆ˜ì •:', { index, history_id: hist.history_id, row_stat: 'U' });
        }
        
        renderHistories();
    }
}

// âœ… ì´ë ¥ ì‚­ì œ í•¨ìˆ˜
function deleteHistory(index) {
    const hist = histories[index];
    
    if (!confirm(`${hist.base_date} ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    // âœ… ì‹ ê·œ(N)ë¡œ ì¶”ê°€ëœ ê²ƒì€ ë°°ì—´ì—ì„œ ì œê±°, ê¸°ì¡´ ë°ì´í„°ëŠ” 'D'ë¡œ í‘œì‹œ
    if (hist.row_stat === 'N') {
        // ì‹ ê·œ ì¶”ê°€ëœ ê²ƒì€ ì™„ì „íˆ ì œê±°
        histories.splice(index, 1);
        console.log('âœ… ì‹ ê·œ ì´ë ¥ ì œê±°:', { index });
    } else {
        // ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œ í‘œì‹œ
        histories[index].row_stat = 'D';
        console.log('âœ… ê¸°ì¡´ ì´ë ¥ ì‚­ì œ í‘œì‹œ:', { index, history_id: hist.history_id, row_stat: 'D' });
    }
    
    renderHistories();
}

// âœ… ì´ë ¥ ë Œë”ë§ í•¨ìˆ˜
function renderHistories() {
    const container = document.getElementById('historiesList');
    if (!container) return;
    
    // ì‚­ì œ í‘œì‹œëœ ê²ƒ ì œì™¸í•˜ê³  í‘œì‹œ
    const visibleHists = histories.filter(h => h.row_stat !== 'D');
    
    if (visibleHists.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>ë“±ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="histories-list">';
    
    visibleHists.forEach((hist) => {
        // ì‹¤ì œ ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        const realIndex = histories.indexOf(hist);
        
        const statusBadge = hist.row_stat === 'N' ? 
            '<span class="badge badge-new">ì‹ ê·œ</span>' : 
            (hist.row_stat === 'U' ? '<span class="badge badge-modified">ìˆ˜ì •ë¨</span>' : '');
        
        html += `
            <div class="history-item">
                <div class="history-info">
                    <div class="history-date">${Utils.formatDate(hist.base_date)}</div>
                    <div class="history-stage">${hist.stage_name || hist.progress_stage}</div>
                    <div class="history-content">${hist.strategy_content || '-'}</div>
                    ${statusBadge}
                </div>
                <div class="history-actions">
                    <button type="button" class="btn-icon" onclick="editHistory(${realIndex})" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn-icon btn-danger" onclick="deleteHistory(${realIndex})" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log('ğŸ“Š ì´ë ¥ ë Œë”ë§:', {
        total: histories.length,
        visible: visibleHists.length,
        new: histories.filter(h => h.row_stat === 'N').length,
        updated: histories.filter(h => h.row_stat === 'U').length,
        deleted: histories.filter(h => h.row_stat === 'D').length
    });
}

// ë ˆê±°ì‹œ í•¨ìˆ˜ í˜¸í™˜ì„± ìœ ì§€
function removeHistory(index) {
    deleteHistory(index);
}

function updateHistory(index) {
    editHistory(index);
}

// ===================================
// Save Project
// ===================================
async function saveProject() {
    try {
        console.log('ğŸ’¾ ========================================');
        console.log('ğŸ’¾ í”„ë¡œì íŠ¸ ì €ì¥ ì‹œì‘');
        console.log('ğŸ’¾ formMode:', formMode);
        console.log('ğŸ’¾ currentPipelineId:', currentPipelineId);
        console.log('ğŸ’¾ ========================================');
        
        // í•„ìˆ˜ ì…ë ¥ í™•ì¸
        const projectName = document.getElementById('project_name').value.trim();
        const fieldCode = document.getElementById('field_code').value;
        const currentStage = document.getElementById('current_stage').value;
        const managerId = document.getElementById('manager_id').value;
        
        if (!projectName) {
            alert('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
            document.getElementById('project_name').focus();
            return;
        }
        
        if (!fieldCode) {
            alert('ì‚¬ì—…ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            document.getElementById('field_code').focus();
            return;
        }
        
        if (!currentStage) {
            alert('ì§„í–‰ë‹¨ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            document.getElementById('current_stage').focus();
            return;
        }
        
        if (!managerId) {
            alert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            document.getElementById('manager_id').focus();
            return;
        }
        
        Utils.showLoading(true);
        
        // âœ… ì†ì„± ë°ì´í„° ì¤€ë¹„ (row_statì´ ìˆëŠ” ê²ƒë§Œ ì „ì†¡)
        const attributesToSave = attributes
            .filter(a => a.row_stat)  // row_statì´ ìˆëŠ” ê²ƒë§Œ (N, U, D)
            .map(a => ({
                attr_code: a.attr_code,
                attr_value: a.attr_value || '',
                row_stat: a.row_stat
            }));
        
        // âœ… ì´ë ¥ ë°ì´í„° ì¤€ë¹„ (row_statì´ ìˆëŠ” ê²ƒë§Œ ì „ì†¡)
        const historiesToSave = histories
            .filter(h => h.row_stat)  // row_statì´ ìˆëŠ” ê²ƒë§Œ (N, U, D)
            .map(h => ({
                history_id: h.history_id || null,
                base_date: h.base_date,
                progress_stage: h.progress_stage,
                strategy_content: h.strategy_content || '',
                row_stat: h.row_stat
            }));
        
        // ë°ì´í„° ìˆ˜ì§‘
        const projectData = {
            project_name: projectName,
            field_code: fieldCode,
            current_stage: currentStage,
            manager_id: managerId,
            customer_id: selectedCustomerId || parseInt(document.getElementById('customer_id')?.value) || null,
            ordering_party_id: selectedOrderingPartyId || parseInt(document.getElementById('ordering_party_id')?.value) || null,
            quoted_amount: parseInt(document.getElementById('quoted_amount').value) || 0,
            win_probability: parseInt(document.getElementById('win_probability')?.value) || 0,
            notes: document.getElementById('notes')?.value?.trim() || '',
            user_id: window.currentUser?.login_id || 'system'
        };
        
        // â­ í•µì‹¬ ìˆ˜ì •: ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ í‚¤ë¥¼ ì¶”ê°€
        console.log('ğŸ’¾ ì €ì¥ ë°ì´í„° ì¤€ë¹„:');
        console.log('   - ì†ì„± ë°°ì—´:', attributes.length, 'ê°œ (row_stat ìˆìŒ:', attributesToSave.length, 'ê°œ)');
        console.log('   - ì´ë ¥ ë°°ì—´:', histories.length, 'ê°œ (row_stat ìˆìŒ:', historiesToSave.length, 'ê°œ)');
        
        if (attributesToSave.length > 0) {
            projectData.attributes = attributesToSave;
            console.log('   âœ… ì†ì„± ë³€ê²½ ì „ì†¡:', attributesToSave);
        } else {
            console.log('   âš ï¸ ì†ì„± ë³€ê²½ ì—†ìŒ â†’ attributes í‚¤ ìƒëµ');
        }
        
        if (historiesToSave.length > 0) {
            projectData.histories = historiesToSave;
            console.log('   âœ… ì´ë ¥ ë³€ê²½ ì „ì†¡:', historiesToSave);
        } else {
            console.log('   âš ï¸ ì´ë ¥ ë³€ê²½ ì—†ìŒ â†’ histories í‚¤ ìƒëµ');
        }
        
        console.log('ğŸ“¤ ìµœì¢… ì „ì†¡ ë°ì´í„°:', projectData);
        
        // â­ API í˜¸ì¶œ - ì‹ ê·œ/ìˆ˜ì • ëª¨ë‘ POST /project-detail/save ì‚¬ìš©
        const response = await API.post(API_CONFIG.ENDPOINTS.PROJECT_SAVE, projectData);
        
        console.log('âœ… ì €ì¥ ì‘ë‹µ:', response);
        
        // âœ… ì‹ ê·œ ë“±ë¡ì¸ ê²½ìš° â†’ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
        if (formMode === 'new' && response.pipeline_id) {
            // ëª¨ë“œ ë³€ê²½
            formMode = 'edit';
            currentPipelineId = response.pipeline_id;
            
            // pipeline_id í‘œì‹œ
            document.getElementById('pipeline_id').value = response.pipeline_id;
            
            // ì œëª© ë³€ê²½
            const titleElement = document.getElementById('formTitle');
            const titleIcon = titleElement.parentElement.querySelector('i');
            titleElement.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';
            if (titleIcon) titleIcon.className = 'fas fa-edit';
            
            Utils.showLoading(false);
            
            // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (row_stat ì´ˆê¸°í™”ë¥¼ ìœ„í•´)
            await loadProjectData(response.pipeline_id);
            
            alert(`í”„ë¡œì íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nPipeline ID: ${response.pipeline_id}`);
        } else {
            Utils.showLoading(false);
            
            // ìˆ˜ì • ëª¨ë“œ: ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (row_stat ì´ˆê¸°í™”)
            await loadProjectData(currentPipelineId);
            
            alert('í”„ë¡œì íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // âœ… ëª©ë¡ìœ¼ë¡œ ì´ë™í•˜ì§€ ì•Šê³  í˜„ì¬ í™”ë©´ ìœ ì§€
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëª©ë¡ ë°ì´í„° ê°±ì‹  (ë‚˜ì¤‘ì— ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œë¥¼ ìœ„í•´)
        if (typeof projectTable !== 'undefined' && projectTable) {
            projectTable.setData();
        }
        
    } catch (error) {
        console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
        Utils.showLoading(false);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (error.message || ''));
    }
}

// ===================================
// Close Form (ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°)
// ===================================
function closeProjectForm() {
    // ëª©ë¡ìœ¼ë¡œ ì´ë™
    navigateTo('projects-list');
    
    // ëª©ë¡ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    if (typeof projectTable !== 'undefined' && projectTable) {
        projectTable.setData();
    }
}

// ===================================
// Cancel Form (ë³€ê²½ ì‚¬í•­ í™•ì¸ í›„ ë‹«ê¸°)
// ===================================
function cancelProjectForm() {
    if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        closeProjectForm();
    }
}

// Event listener for custom event
window.addEventListener('projectFormOpen', (e) => {
    const { mode, pipelineId } = e.detail;
    console.log('ğŸ“¨ projectFormOpen ì´ë²¤íŠ¸ ìˆ˜ì‹ :', mode, pipelineId);
    initializeProjectForm(mode, pipelineId);
});

// Export to window
window.initializeProjectForm = initializeProjectForm;
window.addAttribute = addAttribute;
window.removeAttribute = removeAttribute;
window.updateAttribute = updateAttribute;
window.editAttribute = editAttribute;
window.deleteAttribute = deleteAttribute;
window.addHistory = addHistory;
window.removeHistory = removeHistory;
window.updateHistory = updateHistory;
window.editHistory = editHistory;
window.deleteHistory = deleteHistory;
window.saveProject = saveProject;
window.cancelProjectForm = cancelProjectForm;
window.closeProjectForm = closeProjectForm;
window.openClientSearchModal = openClientSearchModal;
window.closeClientSearchModal = closeClientSearchModal;
window.searchClients = searchClients;
window.selectClient = selectClient;

console.log('ğŸ“¦ Project Form ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
