// ===================================
// static/js/clients-list.js
// ê±°ë˜ì²˜ ëª©ë¡ ê´€ë¦¬ JavaScript
// 
// ê¸°ëŠ¥ ê°œì„  (2026-02-01):
// - ê²€ìƒ‰êµ¬ë¶„ "ì „ì²´" ì§€ì› (search_field ì—†ìœ¼ë©´ ì „ì²´ í•„ë“œ ê²€ìƒ‰)
// - [ì‹ ê·œ] ë²„íŠ¼ í´ë¦­ ì‹œ openClientForm('new') í˜¸ì¶œ
// - ë”ë¸”í´ë¦­ ì‹œ openClientForm('edit', clientId) í˜¸ì¶œ
// - ì•¡ì…˜ ë²„íŠ¼ ìƒ‰ìƒ ê°œì„  (íŒŒë€ìƒ‰ ìˆ˜ì •, ë¹¨ê°„ìƒ‰ ì‚­ì œ)
// - ì•¡ì…˜ ë²„íŠ¼ì—ì„œ ì „ì—­ í•¨ìˆ˜ í˜¸ì¶œ (editClientFromAction, deleteClientFromAction)
// ===================================

// ===================================
// Global State
// ===================================
let clientsTable = null;
let currentClientFilters = {
    search_field: '',
    search_text: '',
    industry_type: '',
    is_active: '',
    page: 1,
    page_size: 25
};

// ===================================
// Initialization
// ===================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ ê±°ë˜ì²˜ ëª©ë¡ ì´ˆê¸°í™” ì‹œì‘...');
    
    // ê±°ë˜ì²˜ ëª©ë¡ í˜ì´ì§€ì¸ì§€ í™•ì¸
    const clientsTableEl = document.getElementById('clientsTable');
    
    if (!clientsTableEl) {
        console.log('âš ï¸ clientsTable ìš”ì†Œ ì—†ìŒ, ì´ˆê¸°í™” ìŠ¤í‚µ');
        return;
    }
    
    try {
        // í…Œì´ë¸” ì´ˆê¸°í™”
        initializeClientsTable();
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        initializeClientEventListeners();
        
        console.log('âœ… ê±°ë˜ì²˜ ëª©ë¡ ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('âŒ ê±°ë˜ì²˜ ëª©ë¡ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
});

// ===================================
// Initialize Clients Table
// ===================================
function initializeClientsTable() {
    const tableEl = document.getElementById('clientsTable');
    
    if (!tableEl) {
        console.error('âŒ clientsTable ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return;
    }
    
    clientsTable = new Tabulator("#clientsTable", {
        height: "600px",
        layout: "fitDataStretch",
        pagination: true,
        paginationMode: "remote",
        paginationSize: 25,
        paginationSizeSelector: [25, 50, 100, 200],
        placeholder: "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤",
        
        selectable: true,
        selectableRangeMode: "click",
        
        ajaxURL: API_CONFIG.BASE_URL + API_CONFIG.API_VERSION + "/clients/list",
        
        ajaxURLGenerator: function(url, config, params) {
            const queryParams = {
                page: params.page || 1,
                page_size: params.size || 25
            };
            
            // â­ ê°œì„ : ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œë§Œ ê²€ìƒ‰ í•„í„° ì ìš©
            // search_fieldê°€ ë¹ˆ ê°’('')ì´ë©´ ì „ì†¡í•˜ì§€ ì•ŠìŒ â†’ ë°±ì—”ë“œì—ì„œ ì „ì²´ ê²€ìƒ‰
            if (currentClientFilters.search_text) {
                queryParams.search_text = currentClientFilters.search_text;
                
                // search_fieldê°€ ìˆì„ ë•Œë§Œ ì¶”ê°€
                if (currentClientFilters.search_field) {
                    queryParams.search_field = currentClientFilters.search_field;
                }
                // search_fieldê°€ ì—†ìœ¼ë©´ ë°±ì—”ë“œì—ì„œ ì „ì²´ í•„ë“œ ê²€ìƒ‰
            }
            
            if (currentClientFilters.industry_type) {
                queryParams.industry_type = currentClientFilters.industry_type;
            }
            if (currentClientFilters.is_active !== '') {
                queryParams.is_active = currentClientFilters.is_active;
            }
            
            const query = new URLSearchParams(queryParams);
            const finalUrl = url + '?' + query.toString();
            console.log('ğŸ“¡ API í˜¸ì¶œ:', finalUrl);
            return finalUrl;
        },
        
        ajaxResponse: function(url, params, response) {
            updateClientStatistics(response);
            return {
                last_page: response.total_pages || 1,
                data: response.items || []
            };
        },
        
        ajaxError: function(error) {
            console.error('âŒ AJAX ì—ëŸ¬:', error);
            return { last_page: 1, data: [] };
        },
        
        columns: [
            {
                formatter: "rowSelection",
                titleFormatter: "rowSelection",
                titleFormatterParams: { rowRange: "active" },
                hozAlign: "center",
                headerSort: false,
                width: 50,
                frozen: true
            },
            {
                title: "ê±°ë˜ì²˜ID",
                field: "client_id",
                width: 100,
                frozen: true,
                headerSort: false,
                formatter: function(cell) {
                    return `<strong>${cell.getValue()}</strong>`;
                }
            },
            {
                title: "ê±°ë˜ì²˜ëª…",
                field: "client_name",
                width: 250,
                headerSort: false,
                formatter: function(cell) {
                    const clientName = cell.getValue() || '';
                    const isActive = cell.getRow().getData().is_active;
                    
                    let badge = '';
                    if (!isActive) {
                        badge = '<span class="badge badge-secondary">ë¹„í™œì„±</span>';
                    }
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #2f5597;">${clientName}</strong>
                            ${badge}
                        </div>
                    `;
                }
            },
            {
                title: "ì‚¬ì—…ìë²ˆí˜¸",
                field: "business_number",
                width: 140,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<code>${value}</code>` : '-';
                }
            },
            {
                title: "ëŒ€í‘œì",
                field: "ceo_name",
                width: 120,
                headerSort: false
            },
            {
                title: "ì—…ì¢…",
                field: "industry_type",
                width: 150,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (!value) return '-';
                    
                    const colorMap = {
                        'ì œì¡°ì—…': '#4caf50',
                        'IT/ì†Œí”„íŠ¸ì›¨ì–´': '#2196f3',
                        'ì„œë¹„ìŠ¤ì—…': '#ff9800',
                        'ê±´ì„¤ì—…': '#795548',
                        'ê¸ˆìœµ/ë³´í—˜': '#9c27b0',
                        'ê³µê³µê¸°ê´€': '#f44336'
                    };
                    
                    const color = colorMap[value] || '#607d8b';
                    
                    return `
                        <span class="badge" style="background: ${color};">
                            ${value}
                        </span>
                    `;
                }
            },
            {
                title: "ì „í™”ë²ˆí˜¸",
                field: "phone",
                width: 140,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value || '-';
                }
            },
            {
                title: "ì´ë©”ì¼",
                field: "email",
                width: 200,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<a href="mailto:${value}">${value}</a>` : '-';
                }
            },
            {
                title: "ì§ì› ìˆ˜",
                field: "employee_count",
                width: 100,
                headerSort: false,
                hozAlign: "right",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.toLocaleString() + 'ëª…' : '-';
                }
            },
            {
                title: "ì„¤ë¦½ì¼",
                field: "established_date",
                width: 120,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value || '-';
                }
            },
            {
                title: "ë“±ë¡ì¼",
                field: "created_at",
                width: 120,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.split('T')[0] : '-';
                }
            },
            {
                title: "ìˆ˜ì •ì¼",
                field: "updated_at",
                width: 120,
                headerSort: false,
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value.split('T')[0] : '-';
                }
            },
            {
                title: "ì•¡ì…˜",
                field: "actions",
                width: 120,
                headerSort: false,
                hozAlign: "center",
                formatter: function(cell) {
                    const clientId = cell.getRow().getData().client_id;
                    // â­ ê°œì„ : ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (íŒŒë€ìƒ‰ ìˆ˜ì •, ë¹¨ê°„ìƒ‰ ì‚­ì œ) + ì–´ë‘ìš´ ë°°ê²½
                    return `
                        <button 
                            class="btn-icon" 
                            onclick="editClientFromAction(${clientId})"
                            title="ìˆ˜ì •"
                            style="background-color: #667eea; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 4px;"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            class="btn-icon" 
                            onclick="deleteClientFromAction(${clientId})"
                            title="ì‚­ì œ"
                            style="background-color: #e53e3e; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ]
    });
    
    // í–‰ ì„ íƒ ì´ë²¤íŠ¸
    clientsTable.on("rowSelectionChanged", function(data, rows) {
        updateSelectionActionBar(rows.length);
    });
    
    // â­ ê°œì„ : ë”ë¸”í´ë¦­ ì‹œ openClientForm í˜¸ì¶œ
    clientsTable.on("rowDblClick", function(e, row) {
        const clientId = row.getData().client_id;
        console.log('ğŸ–±ï¸ ë”ë¸”í´ë¦­:', clientId);
        if (typeof openClientForm === 'function') {
            openClientForm('edit', clientId);
        } else {
            console.error('âŒ openClientForm í•¨ìˆ˜ ì—†ìŒ');
            navigateToClientForm('edit', clientId);
        }
    });
    
    console.log('âœ… ê±°ë˜ì²˜ í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ');
}

// ===================================
// Update Statistics
// ===================================
function updateClientStatistics(response) {
    document.getElementById('statTotal').textContent = response.total || 0;
    document.getElementById('statActive').textContent = response.active_count || 0;
    document.getElementById('statInactive').textContent = response.inactive_count || 0;
    document.getElementById('statFiltered').textContent = response.filtered_count || response.total || 0;
}

// ===================================
// Event Listeners
// ===================================
function initializeClientEventListeners() {
    // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì—”í„°í‚¤
    const searchInput = document.getElementById('clientSearchText');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyClientFilters();
            }
        });
    }
    
    // â­ ê°œì„ : [ì‹ ê·œ] ë²„íŠ¼ í´ë¦­ ì‹œ openClientForm í˜¸ì¶œ
    const btnNew = document.getElementById('btnNewClient');
    if (btnNew) {
        btnNew.addEventListener('click', () => {
            console.log('â• ì‹ ê·œ ê±°ë˜ì²˜ ë²„íŠ¼ í´ë¦­');
            if (typeof openClientForm === 'function') {
                openClientForm('new');
            } else {
                console.error('âŒ openClientForm í•¨ìˆ˜ ì—†ìŒ');
                navigateToClientForm('new');
            }
        });
        console.log('  âœ“ btnNewClient ì´ë²¤íŠ¸ ë“±ë¡ (openClientForm í˜¸ì¶œ)');
    }
    
    console.log('âœ… ê±°ë˜ì²˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
}

// ===================================
// Filter Functions
// ===================================
function applyClientFilters() {
    console.log('ğŸ” í•„í„° ì ìš© ì¤‘...');
    
    currentClientFilters.search_field = document.getElementById('clientSearchField').value;
    currentClientFilters.search_text = document.getElementById('clientSearchText').value;
    currentClientFilters.industry_type = document.getElementById('clientIndustryType').value;
    currentClientFilters.is_active = document.getElementById('clientIsActive').value;
    currentClientFilters.page = 1;
    
    console.log('ğŸ“‹ í•„í„° ì¡°ê±´:', currentClientFilters);
    
    if (clientsTable) {
        clientsTable.setPage(1);
    }
}

function resetClientFilters() {
    console.log('ğŸ”„ í•„í„° ì´ˆê¸°í™”');
    
    document.getElementById('clientSearchField').value = '';
    document.getElementById('clientSearchText').value = '';
    document.getElementById('clientIndustryType').value = '';
    document.getElementById('clientIsActive').value = '';
    
    currentClientFilters = {
        search_field: '',
        search_text: '',
        industry_type: '',
        is_active: '',
        page: 1,
        page_size: 25
    };
    
    if (clientsTable) {
        clientsTable.setPage(1);
    }
}

// ===================================
// Selection Functions
// ===================================
function updateSelectionActionBar(count) {
    const actionBar = document.getElementById('clientSelectionActionBar');
    const countSpan = document.getElementById('clientSelectionCount');
    
    if (count > 0) {
        actionBar.style.display = 'flex';
        countSpan.textContent = count;
    } else {
        actionBar.style.display = 'none';
    }
}

function clearClientSelection() {
    if (clientsTable) {
        clientsTable.deselectRow();
    }
}

// ===================================
// Navigation Functions
// ===================================
function navigateToClientForm(mode, clientId = null) {
    console.log('ğŸ“ í˜ì´ì§€ ì´ë™:', mode, clientId);
    
    if (typeof loadPage === 'function') {
        if (mode === 'new') {
            loadPage('clients-form', { mode: 'new' });
        } else if (mode === 'edit' && clientId) {
            loadPage('clients-form', { mode: 'edit', client_id: clientId });
        }
    } else {
        console.error('âŒ loadPage í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    }
}

function navigateToClientList() {
    console.log('ğŸ“ ëª©ë¡ìœ¼ë¡œ ì´ë™');
    
    if (typeof loadPage === 'function') {
        loadPage('clients-list');
    } else {
        console.error('âŒ loadPage í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    }
}

// ===================================
// â­ ì•¡ì…˜ ë²„íŠ¼ ì „ì—­ í•¨ìˆ˜ (ì‹ ê·œ ì¶”ê°€)
// ===================================
function editClientFromAction(clientId) {
    console.log('âœï¸ ì•¡ì…˜ ë²„íŠ¼ - ìˆ˜ì •:', clientId);
    if (typeof openClientForm === 'function') {
        openClientForm('edit', clientId);
    } else {
        console.error('âŒ openClientForm í•¨ìˆ˜ ì—†ìŒ');
        navigateToClientForm('edit', clientId);
    }
}

function deleteClientFromAction(clientId) {
    console.log('ğŸ—‘ï¸ ì•¡ì…˜ ë²„íŠ¼ - ì‚­ì œ:', clientId);
    deleteClientById(clientId);
}

// ===================================
// Delete Functions
// ===================================
async function deleteClientById(clientId) {
    if (!confirm('ì •ë§ë¡œ ì´ ê±°ë˜ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        console.log('ğŸ—‘ï¸ ê±°ë˜ì²˜ ì‚­ì œ:', clientId);
        
        const response = await API.delete(`/clients/${clientId}`);
        
        console.log('âœ… ì‚­ì œ ì„±ê³µ');
        alert('ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
        if (clientsTable) {
            clientsTable.replaceData();
        }
        
    } catch (error) {
        console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ê±°ë˜ì²˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

async function bulkDeleteClients() {
    const selectedRows = clientsTable.getSelectedRows();
    
    if (selectedRows.length === 0) {
        alert('ì‚­ì œí•  ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`ì„ íƒí•œ ${selectedRows.length}ê°œì˜ ê±°ë˜ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        console.log('ğŸ—‘ï¸ ëŒ€ëŸ‰ ì‚­ì œ ì‹œì‘:', selectedRows.length);
        
        const deletePromises = selectedRows.map(row => {
            const clientId = row.getData().client_id;
            return API.delete(`/clients/${clientId}`);
        });
        
        await Promise.all(deletePromises);
        
        console.log('âœ… ëŒ€ëŸ‰ ì‚­ì œ ì„±ê³µ');
        alert(`${selectedRows.length}ê°œì˜ ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
        if (clientsTable) {
            clientsTable.replaceData();
        }
        
    } catch (error) {
        console.error('âŒ ëŒ€ëŸ‰ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ê±°ë˜ì²˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ===================================
// Export Functions
// ===================================
function exportClientsToExcel() {
    if (!clientsTable) {
        console.error('âŒ í…Œì´ë¸”ì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
        return;
    }
    
    console.log('ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
    
    clientsTable.download("xlsx", "ê±°ë˜ì²˜ëª©ë¡.xlsx", {
        sheetName: "ê±°ë˜ì²˜"
    });
}

function bulkExportClients() {
    const selectedRows = clientsTable.getSelectedRows();
    
    if (selectedRows.length === 0) {
        alert('ë‚´ë³´ë‚¼ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    console.log('ğŸ“Š ì„ íƒ í•­ëª© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ:', selectedRows.length);
    
    clientsTable.download("xlsx", "ì„ íƒê±°ë˜ì²˜.xlsx", {
        sheetName: "ì„ íƒê±°ë˜ì²˜"
    }, "selected");
}

// ===================================
// Export to window
// ===================================
window.editClientFromAction = editClientFromAction;      // â­ ì‹ ê·œ ì¶”ê°€
window.deleteClientFromAction = deleteClientFromAction;  // â­ ì‹ ê·œ ì¶”ê°€
window.navigateToClientForm = navigateToClientForm;
window.navigateToClientList = navigateToClientList;
window.deleteClientById = deleteClientById;
window.bulkDeleteClients = bulkDeleteClients;
window.exportClientsToExcel = exportClientsToExcel;
window.bulkExportClients = bulkExportClients;
window.applyClientFilters = applyClientFilters;
window.resetClientFilters = resetClientFilters;
window.clearClientSelection = clearClientSelection;

console.log('âœ… clients-list.js ë¡œë“œ ì™„ë£Œ');
