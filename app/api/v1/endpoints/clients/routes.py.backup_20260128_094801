# -*- coding: utf-8 -*-
"""
ê±°ë˜ì²˜ ê´€ë¦¬ API ì—”ë“œí¬ì¸íŠ¸
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from sqlalchemy import text
from typing import Optional
from app.core.database import get_db
from app.core.logger import app_logger

router = APIRouter()


# ============================================
# ê±°ë˜ì²˜ ê²€ìƒ‰
# ============================================
@router.get("/search")
async def search_clients(
    search: str = Query("", description="ê²€ìƒ‰ì–´"),
    limit: int = Query(50, ge=1, le=100, description="ì¡°íšŒ ê°œìˆ˜"),
    db: Session = Depends(get_db)
):
    """
    ê±°ë˜ì²˜ ê²€ìƒ‰
    
    Args:
        search: ê²€ìƒ‰ì–´ (ê±°ë˜ì²˜ëª…, ì‚¬ì—…ìë²ˆí˜¸, ëŒ€í‘œìëª…)
        limit: ì¡°íšŒ ê°œìˆ˜
        db: ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
    
    Returns:
        ê²€ìƒ‰ëœ ê±°ë˜ì²˜ ëª©ë¡
    """
    try:
        app_logger.info(f"ğŸ” ê±°ë˜ì²˜ ê²€ìƒ‰ - search: '{search}', limit: {limit}")
        
        query_str = """
            SELECT 
                client_id,
                client_name,
                business_number,
                ceo_name,
                phone,
                address,
                email,
                industry_type,
                is_active
            FROM clients
            WHERE (is_active IS NULL OR is_active = 1)
        """
        
        params = {'limit': limit}
        
        if search and search.strip():
            query_str += """
                AND (
                    client_name LIKE :search 
                    OR business_number LIKE :search_exact
                    OR ceo_name LIKE :search
                )
                ORDER BY 
                    CASE 
                        WHEN client_name LIKE :search_start THEN 1
                        ELSE 2
                    END,
                    client_name ASC
            """
            search_term = search.strip()
            params['search'] = f"%{search_term}%"
            params['search_exact'] = search_term
            params['search_start'] = f"{search_term}%"
        else:
            query_str += " ORDER BY client_name ASC"
        
        query_str += " LIMIT :limit"
        
        # ì¿¼ë¦¬ ì‹¤í–‰
        result = db.execute(text(query_str), params)
        rows = result.fetchall()
        
        # ê²°ê³¼ ë³€í™˜
        clients = []
        for row in rows:
            clients.append({
                'client_id': row[0],
                'client_name': row[1] or '',
                'business_number': row[2] or '',
                'ceo_name': row[3] or '',
                'phone': row[4] or '',
                'address': row[5] or '',
                'email': row[6] or '',
                'industry_type': row[7] or '',
                'is_active': bool(row[8]) if row[8] is not None else True
            })
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ê²€ìƒ‰ ì„±ê³µ - {len(clients)}ê°œ")
        
        return {
            "clients": clients,
            "total": len(clients)
        }
        
    except Exception as e:
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ê²€ìƒ‰ ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ê²€ìƒ‰ ì‹¤íŒ¨: {str(e)}")


# ============================================
# ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ
# ============================================
@router.get("/list")
async def get_clients_list(
    search: Optional[str] = Query(None, description="ê²€ìƒ‰ì–´"),
    is_active: Optional[bool] = Query(None, description="í™œì„± ìƒíƒœ"),
    limit: int = Query(50, ge=1, le=100),
    offset: int = Query(0, ge=0),
    db: Session = Depends(get_db)
):
    """
    ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ
    
    Args:
        search: ê²€ìƒ‰ì–´ (ê±°ë˜ì²˜ëª…, ì‚¬ì—…ìë²ˆí˜¸)
        is_active: í™œì„± ìƒíƒœ í•„í„°
        limit: ì¡°íšŒ ê°œìˆ˜
        offset: ì‹œì‘ ìœ„ì¹˜
        db: ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
    
    Returns:
        ê±°ë˜ì²˜ ëª©ë¡
    """
    try:
        app_logger.info(f"ğŸ“‹ ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ - search: {search}, limit: {limit}, offset: {offset}")
        
        # ê¸°ë³¸ ì¿¼ë¦¬
        query_str = """
            SELECT 
                client_id,
                client_name,
                business_number,
                ceo_name,
                address,
                phone,
                email,
                fax,
                homepage,
                industry_type,
                employee_count,
                established_date,
                is_active,
                remarks,
                created_at,
                updated_at
            FROM clients
            WHERE 1=1
        """
        
        count_query_str = "SELECT COUNT(*) as total FROM clients WHERE 1=1"
        
        params = {}
        
        # ê²€ìƒ‰ ì¡°ê±´
        if search and search.strip():
            search_condition = """
                AND (
                    client_name LIKE :search 
                    OR business_number LIKE :search
                    OR ceo_name LIKE :search
                )
            """
            query_str += search_condition
            count_query_str += search_condition
            params['search'] = f"%{search.strip()}%"
        
        # í™œì„± ìƒíƒœ í•„í„°
        if is_active is not None:
            query_str += " AND is_active = :is_active"
            count_query_str += " AND is_active = :is_active"
            params['is_active'] = 1 if is_active else 0
        else:
            # ê¸°ë³¸ì ìœ¼ë¡œ í™œì„± ê±°ë˜ì²˜ë§Œ ì¡°íšŒ
            query_str += " AND (is_active IS NULL OR is_active = 1)"
            count_query_str += " AND (is_active IS NULL OR is_active = 1)"
        
        # ì •ë ¬ ë° í˜ì´ì§•
        query_str += " ORDER BY client_name ASC LIMIT :limit OFFSET :offset"
        params['limit'] = limit
        params['offset'] = offset
        
        # ì¿¼ë¦¬ ì‹¤í–‰
        result = db.execute(text(query_str), params)
        rows = result.fetchall()
        
        # ì „ì²´ ê°œìˆ˜ ì¡°íšŒ
        count_params = {k: v for k, v in params.items() if k not in ['limit', 'offset']}
        count_result = db.execute(text(count_query_str), count_params)
        total = count_result.fetchone()[0]
        
        # ê²°ê³¼ ë³€í™˜
        clients = []
        for row in rows:
            clients.append({
                'client_id': row[0],
                'client_name': row[1] or '',
                'business_number': row[2] or '',
                'ceo_name': row[3] or '',
                'address': row[4] or '',
                'phone': row[5] or '',
                'email': row[6] or '',
                'fax': row[7] or '',
                'homepage': row[8] or '',
                'industry_type': row[9] or '',
                'employee_count': row[10],
                'established_date': row[11].isoformat() if row[11] else None,
                'is_active': bool(row[12]) if row[12] is not None else True,
                'remarks': row[13] or '',
                'created_at': row[14].isoformat() if row[14] else None,
                'updated_at': row[15].isoformat() if row[15] else None,
            })
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ - {len(clients)}ê°œ / ì „ì²´ {total}ê°œ")
        
        return {
            "clients": clients,
            "total": total,
            "limit": limit,
            "offset": offset
        }
        
    except Exception as e:
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")


# ============================================
# ê±°ë˜ì²˜ ìƒì„¸ ì¡°íšŒ
# ============================================
@router.get("/{client_id}")
async def get_client_detail(
    client_id: int,
    db: Session = Depends(get_db)
):
    """ê±°ë˜ì²˜ ìƒì„¸ ì •ë³´ ì¡°íšŒ"""
    try:
        app_logger.info(f"ğŸ“„ ê±°ë˜ì²˜ ìƒì„¸ ì¡°íšŒ - client_id: {client_id}")
        
        query = text("""
            SELECT 
                client_id,
                client_name,
                business_number,
                ceo_name,
                address,
                phone,
                email,
                fax,
                homepage,
                industry_type,
                employee_count,
                established_date,
                is_active,
                remarks,
                created_at,
                updated_at
            FROM clients
            WHERE client_id = :client_id
        """)
        
        result = db.execute(query, {'client_id': client_id})
        row = result.fetchone()
        
        if not row:
            raise HTTPException(status_code=404, detail="ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        client = {
            'client_id': row[0],
            'client_name': row[1] or '',
            'business_number': row[2] or '',
            'ceo_name': row[3] or '',
            'address': row[4] or '',
            'phone': row[5] or '',
            'email': row[6] or '',
            'fax': row[7] or '',
            'homepage': row[8] or '',
            'industry_type': row[9] or '',
            'employee_count': row[10],
            'established_date': row[11].isoformat() if row[11] else None,
            'is_active': bool(row[12]) if row[12] is not None else True,
            'remarks': row[13] or '',
            'created_at': row[14].isoformat() if row[14] else None,
            'updated_at': row[15].isoformat() if row[15] else None,
        }
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ìƒì„¸ ì¡°íšŒ ì„±ê³µ")
        
        return {"client": client}
        
    except HTTPException:
        raise
    except Exception as e:
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}")


# ============================================
# ê±°ë˜ì²˜ ë“±ë¡
# ============================================
@router.post("")
async def create_client(
    client_name: str,
    business_number: Optional[str] = None,
    ceo_name: Optional[str] = None,
    address: Optional[str] = None,
    phone: Optional[str] = None,
    email: Optional[str] = None,
    fax: Optional[str] = None,
    homepage: Optional[str] = None,
    industry_type: Optional[str] = None,
    employee_count: Optional[int] = None,
    established_date: Optional[str] = None,
    remarks: Optional[str] = None,
    db: Session = Depends(get_db)
):
    """ê±°ë˜ì²˜ ë“±ë¡"""
    try:
        app_logger.info(f"ğŸ“ ê±°ë˜ì²˜ ë“±ë¡ - client_name: {client_name}")
        
        query = text("""
            INSERT INTO clients (
                client_name,
                business_number,
                ceo_name,
                address,
                phone,
                email,
                fax,
                homepage,
                industry_type,
                employee_count,
                established_date,
                remarks,
                is_active
            ) VALUES (
                :client_name,
                :business_number,
                :ceo_name,
                :address,
                :phone,
                :email,
                :fax,
                :homepage,
                :industry_type,
                :employee_count,
                :established_date,
                :remarks,
                1
            )
        """)
        
        params = {
            'client_name': client_name,
            'business_number': business_number,
            'ceo_name': ceo_name,
            'address': address,
            'phone': phone,
            'email': email,
            'fax': fax,
            'homepage': homepage,
            'industry_type': industry_type,
            'employee_count': employee_count,
            'established_date': established_date,
            'remarks': remarks
        }
        
        result = db.execute(query, params)
        db.commit()
        
        client_id = result.lastrowid
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ë“±ë¡ ì„±ê³µ - client_id: {client_id}")
        
        return {
            "message": "ê±°ë˜ì²˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤",
            "client_id": client_id
        }
        
    except Exception as e:
        db.rollback()
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ë“±ë¡ ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ë“±ë¡ ì‹¤íŒ¨: {str(e)}")


# ============================================
# ê±°ë˜ì²˜ ìˆ˜ì •
# ============================================
@router.put("/{client_id}")
async def update_client(
    client_id: int,
    client_name: Optional[str] = None,
    business_number: Optional[str] = None,
    ceo_name: Optional[str] = None,
    address: Optional[str] = None,
    phone: Optional[str] = None,
    email: Optional[str] = None,
    fax: Optional[str] = None,
    homepage: Optional[str] = None,
    industry_type: Optional[str] = None,
    employee_count: Optional[int] = None,
    established_date: Optional[str] = None,
    is_active: Optional[bool] = None,
    remarks: Optional[str] = None,
    db: Session = Depends(get_db)
):
    """ê±°ë˜ì²˜ ì •ë³´ ìˆ˜ì •"""
    try:
        app_logger.info(f"âœï¸ ê±°ë˜ì²˜ ìˆ˜ì • - client_id: {client_id}")
        
        # ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        check_query = text("SELECT client_id FROM clients WHERE client_id = :client_id")
        result = db.execute(check_query, {'client_id': client_id})
        if not result.fetchone():
            raise HTTPException(status_code=404, detail="ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        # ìˆ˜ì •í•  í•„ë“œë§Œ UPDATE
        update_fields = []
        params = {'client_id': client_id}
        
        if client_name is not None:
            update_fields.append("client_name = :client_name")
            params['client_name'] = client_name
        
        if business_number is not None:
            update_fields.append("business_number = :business_number")
            params['business_number'] = business_number
        
        if ceo_name is not None:
            update_fields.append("ceo_name = :ceo_name")
            params['ceo_name'] = ceo_name
        
        if address is not None:
            update_fields.append("address = :address")
            params['address'] = address
        
        if phone is not None:
            update_fields.append("phone = :phone")
            params['phone'] = phone
        
        if email is not None:
            update_fields.append("email = :email")
            params['email'] = email
        
        if fax is not None:
            update_fields.append("fax = :fax")
            params['fax'] = fax
        
        if homepage is not None:
            update_fields.append("homepage = :homepage")
            params['homepage'] = homepage
        
        if industry_type is not None:
            update_fields.append("industry_type = :industry_type")
            params['industry_type'] = industry_type
        
        if employee_count is not None:
            update_fields.append("employee_count = :employee_count")
            params['employee_count'] = employee_count
        
        if established_date is not None:
            update_fields.append("established_date = :established_date")
            params['established_date'] = established_date
        
        if is_active is not None:
            update_fields.append("is_active = :is_active")
            params['is_active'] = 1 if is_active else 0
        
        if remarks is not None:
            update_fields.append("remarks = :remarks")
            params['remarks'] = remarks
        
        if not update_fields:
            raise HTTPException(status_code=400, detail="ìˆ˜ì •í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤")
        
        query_str = f"""
            UPDATE clients
            SET {', '.join(update_fields)}
            WHERE client_id = :client_id
        """
        
        db.execute(text(query_str), params)
        db.commit()
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ìˆ˜ì • ì„±ê³µ")
        
        return {
            "message": "ê±°ë˜ì²˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤",
            "client_id": client_id
        }
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ìˆ˜ì • ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ìˆ˜ì • ì‹¤íŒ¨: {str(e)}")


# ============================================
# ê±°ë˜ì²˜ ì‚­ì œ (ë¹„í™œì„±í™”)
# ============================================
@router.delete("/{client_id}")
async def delete_client(
    client_id: int,
    db: Session = Depends(get_db)
):
    """ê±°ë˜ì²˜ ì‚­ì œ (ë¹„í™œì„±í™”)"""
    try:
        app_logger.info(f"ğŸ—‘ï¸ ê±°ë˜ì²˜ ì‚­ì œ - client_id: {client_id}")
        
        # ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        check_query = text("SELECT client_id FROM clients WHERE client_id = :client_id")
        result = db.execute(check_query, {'client_id': client_id})
        if not result.fetchone():
            raise HTTPException(status_code=404, detail="ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        # ë¹„í™œì„±í™” ì²˜ë¦¬
        query = text("UPDATE clients SET is_active = 0 WHERE client_id = :client_id")
        db.execute(query, {'client_id': client_id})
        db.commit()
        
        app_logger.info(f"âœ… ê±°ë˜ì²˜ ì‚­ì œ(ë¹„í™œì„±í™”) ì„±ê³µ")
        
        return {
            "message": "ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",
            "client_id": client_id
        }
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        app_logger.error(f"âŒ ê±°ë˜ì²˜ ì‚­ì œ ì‹¤íŒ¨: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ê±°ë˜ì²˜ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")
