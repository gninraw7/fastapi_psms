"""
공통코드 관련 API 엔드포인트
"""
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import func
from typing import List
from app.core.database import get_db
from app.models.common import CommonCode
from app.models.user import User

router = APIRouter()


@router.get("/codes/{group_code}")
async def get_common_codes(
    group_code: str,
    db: Session = Depends(get_db)
):
    """
    공통코드 조회
    
    Args:
        group_code: 공통코드 그룹 (STAGE, FIELD 등)
        
    Returns:
        List[dict]: 공통코드 목록
    """
    try:
        codes = db.query(CommonCode).filter(
            CommonCode.group_code == group_code
        ).order_by(CommonCode.sort_order).all()
        
        if not codes:
            return []
        
        return [
            {
                "group_code": code.group_code,
                "code": code.code,
                "code_name": code.code_name,
                "sort_order": code.sort_order
            }
            for code in codes
        ]
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"공통코드 조회 중 오류 발생: {str(e)}"
        )


@router.get("/managers")
async def get_managers(
    db: Session = Depends(get_db)
):
    """
    담당자(영업 대표) 목록 조회
    
    Returns:
        List[dict]: 담당자 목록
    """
    try:
        # 활성 상태이면서 영업 대표인 사용자만 조회
        managers = db.query(User).filter(
            User.status == "ACTIVE",
            User.is_sales_rep == True
        ).order_by(User.user_name).all()
        
        if not managers:
            # 데이터가 없으면 모든 활성 사용자 반환
            managers = db.query(User).filter(
                User.status == "ACTIVE"
            ).order_by(User.user_name).all()
        
        return [
            {
                "login_id": user.login_id,
                "user_name": user.user_name,
                "department": user.department if hasattr(user, 'department') else None,
                "display_name": f"{user.login_id} ({user.user_name})"
            }
            for user in managers
        ]
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"담당자 목록 조회 중 오류 발생: {str(e)}"
        )


@router.get("/code-groups")
async def get_code_groups(
    db: Session = Depends(get_db)
):
    """
    공통코드 그룹 목록 조회
    
    Returns:
        List[str]: 그룹 코드 목록
    """
    try:
        groups = db.query(
            CommonCode.group_code
        ).distinct().order_by(CommonCode.group_code).all()
        
        return [group[0] for group in groups]
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"코드 그룹 조회 중 오류 발생: {str(e)}"
        )
